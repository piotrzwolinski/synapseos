# =============================================================================
# DOMAIN CONFIGURATION - HVAC Air Filtration
# =============================================================================
# This file contains ALL domain-specific logic. The Python code is generic.
# To switch domains, replace this file (e.g., with car_insurance_config.yaml).
# =============================================================================

domain:
  id: "hvac_filtration"
  name: "Air Filtration Systems"
  company: "Mann+Hummel"
  description: "Sales Engineering Assistant for industrial air filtration products"
  version: "2.0"
  graph_name: "hvac"

# =============================================================================
# ENTITY PATTERNS
# =============================================================================
# Regex patterns to extract domain entities from user queries.
# Each pattern has a type, regex, and optional normalization rules.

entity_patterns:
  # Product codes - main identifiable items
  product_codes:
    - pattern: '\b([A-Z]{2,4}[-\s]?\d+x\d+(?:[-x]\d+)?)\b'
      description: "Standard product code with dimensions"
      flags: "IGNORECASE"
      examples: ["GDC-600x600", "GDP-900x600-1200"]

    - pattern: '\b([A-Z]{2,4}[-\s]?FLEX[-\s]?\d+x\d+)\b'
      description: "Flexible variant products"
      flags: "IGNORECASE"
      examples: ["GDC-FLEX-600x600", "GDMI-FLEX-600x600"]

    - pattern: '\b([A-Z]{2,4}[-\s]?[A-Za-z]+[-\s]?\d+[/x]\d+)\b'
      description: "Named variant products"
      flags: "IGNORECASE"
      examples: ["GDR-Nano-1/1"]

    - pattern: '\b(ECO-[A-Z][-\s]?\d+)\b'
      description: "ECO series components"
      flags: "IGNORECASE"
      examples: ["ECO-C 2600", "ECO-F 3200"]

  # Product families - broader categories
  product_families:
    values: ["GDC-FLEX", "GDC", "GDP", "GDR", "GDF", "GDMI", "GDB", "PFF", "BFF"]
    description: "Product family prefixes that trigger catalog search"

  # Material codes
  material_codes:
    values: ["FZ", "ZM", "RF", "SS", "ALU", "AZ"]
    description: "Material specification codes"

  # Option codes
  option_codes:
    values: ["EXL", "L", "F", "Polis"]
    description: "Configuration option codes"

  normalization:
    replace_space_with: "-"
    uppercase: true

# =============================================================================
# DISPLAY SCHEMA
# =============================================================================
# Maps database fields to display labels. The renderer iterates over this.
# No field names are hardcoded in Python.

display_schema:
  # Primary entity display (products/variants)
  primary_entity:
    header_template: "### {icon} {title}"
    icon: "üì¶"
    title: "PRODUCT CONFIGURATION DATA"

    fields:
      - key: "id"
        label: "Product ID"
        format: "**Product: {value}**"
        required: true

      - key: "family"
        label: "Product Family"
        format: "  Family: {value}"

      - key: "width_mm"
        label: "Width"
        format: "  Width: {value}mm"
        combine_with: "height_mm"
        combined_format: "  Dimensions: {width_mm}x{height_mm}mm"

      - key: "height_mm"
        label: "Height"
        hidden_if_combined: true

      - key: "depth_mm"
        label: "Depth"
        format: "  Depth: {value}mm"
        append_to_combined: true
        append_format: " x {value}mm depth"

      - key: "cartridge_count"
        label: "Cartridge Capacity"
        format: "  Cartridge Capacity: {value} units"

      - key: "airflow_m3h"
        label: "Reference Airflow"
        format: "  Reference Airflow: {value} m¬≥/h"
        fallback_keys: ["reference_airflow_m3h"]

      - key: "weight_kg"
        label: "Weight"
        format: "  Weight: {value} kg"

      - key: "is_insulated"
        label: "Thermal Insulation"
        format: "  Special: Thermally insulated (anti-condensation)"
        display_only_if_true: true

      - key: "length_min_mm"
        label: "Minimum Length"
        combine_with: "length_max_mm"
        combined_format: "  Adjustable Length: {length_min_mm}-{length_max_mm}mm"

      - key: "length_max_mm"
        label: "Maximum Length"
        hidden_if_combined: true

      - key: "special_features"
        label: "Special Features"
        format: "  Features: {value}"
        is_array: true
        array_join: ", "

      - key: "available_depths_mm"
        label: "Available Depths"
        format: "  Available Depths: {value}mm"
        is_array: true
        array_join: ", "

      - key: "available_materials"
        label: "Available Materials"
        format: "  Materials: {value}"
        is_array: true
        array_join: ", "

    options_display:
      header: "  **Configuration Options:**"
      json_key: "options_json"
      fallback_key: "available_options"
      format: "    ‚Ä¢ Code **\"{code}\"**: {description}"
      category_format: " [{category}]"

  # Secondary entity types
  secondary_entities:
    cartridges:
      header: "### üîµ FILTER CARTRIDGES"
      fields:
        - key: "model_name"
          format: "**{value}**"
          fallback_keys: ["id"]
        - key: "weight_kg"
          format: " - {value}kg"
        - key: "media_type"
          format: " ({value})"
      item_prefix: "  ‚Ä¢ "

    filters:
      header: "### üìã CONSUMABLE FILTERS"
      fields:
        - key: "part_number"
          format: "Part# **{value}**"
          default: "N/A"
        - key: "model_name"
          format: " - {value}"
        - key: "filter_type"
          format: " ({value})"
      item_prefix: "  ‚Ä¢ "

    materials:
      header: "### üîß MATERIAL SPECIFICATIONS"
      fields:
        - key: "code"
          format: "**{value}**"
        - key: "full_name"
          format: " ({value})"
        - key: "corrosion_class"
          format: " - Corrosion Class: **{value}**"
        - key: "description"
          format: " - {value}"
      item_prefix: "  ‚Ä¢ "

    option_matches:
      header: "### üîß PRODUCTS WITH MATCHING OPTIONS"
      show_options: true
      fields:
        - key: "variant_id"
          format: "**{value}**"
        - key: "family"
          format: " ({value})"

# =============================================================================
# AUTONOMOUS REASONING (No Hardcoded Policies)
# =============================================================================
# The LLM uses its pre-trained engineering knowledge to detect risks.
# We only keep the SIZING constraint as programmatic (critical for safety).

programmatic_constraints:
  # Sizing is kept as programmatic because it's a hard mathematical constraint
  sizing:
    enabled: true
    description: "Airflow capacity must meet or exceed user requirement"
    keywords: ["airflow", "cfm", "m¬≥/h", "capacity", "przep≈Çyw", "wydatek"]

# =============================================================================
# SEARCH KEYWORDS
# =============================================================================
# Keywords that trigger configuration graph searches

search_triggers:
  option_keywords:
    - "option"
    - "opcj"
    - "kod"
    - "code"
    - "hinging"
    - "flange"
    - "frame"
    - "left"
    - "right"
    - "material"
    - "depth"
    - "dimension"
    - "filter"
    - "rail"
    - "locking"
    - "eccentric"

  material_keywords:
    - "corrosion"
    - "koroz"
    - "steel"
    - "stal"
    - "galvanized"
    - "stainless"

  technical_keywords:
    - "capacity"
    - "airflow"
    - "temperature"
    - "pressure"
    - "efficiency"

# =============================================================================
# PROMPTS
# =============================================================================

prompts:
  system: |
    You are a Sales Engineering Assistant. Help customers select the right products.

    ## CORE RULES

    1. **Listen to DESCRIPTION, not just product name**: If customer asks for Product X but describes needing something different (e.g., "just the frame", "without housing"), they probably need a different product. PIVOT.

    2. **Match product to application**: Each product family handles specific things. Wrong type = PIVOT to correct family.

    3. **Match material to environment**: Check environment requirements in domain rules. Wrong material = WARN STRONGLY.

    4. **Respect physical constraints**: If domain rules say option X requires minimum Y mm, and housing is smaller, the configuration is IMPOSSIBLE. BLOCK it.

    5. **Flag tight fits**: Zero installation margin = WARN about risk.

    6. **Get complete data**: No airflow specified = ASK before sizing.

    ## ACTIONS
    - **BLOCK**: Physically impossible. Do not proceed. Explain why. Suggest valid config.
    - **PIVOT**: Customer needs different product than requested. Recommend correct one.
    - **WARN**: Risk detected. Recommend better option.
    - **ASK**: Missing critical info.

    ## TENANT-SPECIFIC RULES
    {active_policies}

  synthesis: |
    ## PRODUCT DATA
    {context}

    ## AVAILABLE PRODUCTS
    {products}

    ## QUERY
    {query}

    ## DOMAIN-SPECIFIC RULES (MUST FOLLOW)
    {policies}

    ## INSTRUCTIONS

    Respond in the same language as the query.

    **VALIDATION CHECKS:**

    1. **Product vs Component**: Does customer's DESCRIPTION match what they're ASKING for?
       - If they ask for a complete product but describe needing only a part/frame ‚Üí PIVOT to the component product
       - Check "Triggers" in DOMAIN RULES for phrases that indicate mismatch

    2. **Application Match**: Does product filter the right thing?
       - If product doesn't filter what customer needs ‚Üí PIVOT to correct product family

    3. **Material Match**: Does material suit environment?
       - Check DOMAIN RULES for environment requirements
       - If mismatch ‚Üí WARN STRONGLY and recommend required material grade

    4. **Geometric Fit**: Do options fit housing dimensions?
       - Check DOMAIN RULES for minimum length requirements
       - If option requires MORE length than housing has ‚Üí BLOCK (physically impossible)
       - Do NOT suggest workarounds - the configuration CANNOT work

    5. **Installation Clearance**: Is there margin?
       - If total length = available space exactly ‚Üí WARN about zero-tolerance risk

    6. **Missing Data**: Is airflow/size specified?
       - If missing ‚Üí ASK before recommending

    **ACTIONS:**
    - BLOCK = refuse, explain physical impossibility, suggest valid alternative
    - PIVOT = recommend different product that matches actual need
    - WARN = alert to risk, recommend better option
    - ASK = request missing information

  no_context: |
    I don't have specific product data for this query in the Knowledge Graph.

    Please contact technical support or consult official product documentation.
    I can still help with general questions based on engineering principles.

# =============================================================================
# STRUCTURED OUTPUT SCHEMA
# =============================================================================

output_schema:
  type: "object"
  properties:
    intent_analysis:
      type: "string"
      description: "Analysis of what the user is trying to accomplish"

    policy_analysis:
      type: "string"
      description: "Guardian reasoning - which policies triggered and validation results"

    graph_evidence:
      type: "array"
      items:
        type: "object"
        properties:
          fact: { type: "string" }
          source_id: { type: "string" }
          confidence: { type: "string", enum: ["verified", "inferred"] }
      description: "Facts extracted from graph with citations"

    general_knowledge:
      type: "string"
      description: "Additional context from model training, clearly marked as unverified"

    final_answer:
      type: "string"
      description: "The complete response to show the user"

    confidence_level:
      type: "string"
      enum: ["high", "medium", "low"]
      description: "Overall confidence based on graph data availability"

    sources:
      type: "array"
      items: { type: "string" }
      description: "List of node IDs used in the response"

    warnings:
      type: "array"
      items: { type: "string" }
      description: "Any policy warnings or validation failures"

# =============================================================================
# PROJECT SEARCH CONFIGURATION
# =============================================================================

project_search:
  patterns:
    - '(\w+)\s+project'
    - 'project\s+(\w+)'
    - '(\w+)\s+case'
    - 'case\s+(\w+)'

  known_identifiers:
    - "huddinge"
    - "knittel"

  stopwords:
    - "a"
    - "an"
    - "the"
    - "my"
    - "your"
    - "this"
    - "that"
    - "is"
    - "are"
    - "what"
    - "which"
    - "how"
    - "new"
    - "similar"

# =============================================================================
# MATERIAL-ENVIRONMENT RULES (Guardian Logic)
# =============================================================================
# These rules define material corrosion classes and environment requirements.
# The LLM uses these to detect mismatches and generate warnings.

material_environment_rules:
  # Material corrosion class hierarchy (lower number = less resistant)
  material_hierarchy:
    - code: "FZ"
      full_name: "Galvanized Steel (Zinc)"
      corrosion_class: "C3"
      description: "Standard indoor, mild environments"
      suitable_for: ["office", "warehouse", "light industrial", "retail", "residential"]

    - code: "ZM"
      full_name: "Zinc-Magnesium Coated (ZM310)"
      corrosion_class: "C5"
      description: "High corrosion resistance ‚Äî coastal, industrial, outdoor"
      suitable_for: ["coastal", "outdoor", "industrial", "commercial kitchen", "laundry", "parking garage"]

    - code: "RF"
      full_name: "Stainless Steel (1.4301/304)"
      corrosion_class: "C5"
      description: "Demanding: healthcare, food, wet, chemical, marine"
      suitable_for: ["hospital", "medical", "food processing", "pharma", "laboratory", "clean room", "pool", "marine", "chemical"]

    - code: "SF"
      full_name: "Stainless Steel (1.4404/316L)"
      corrosion_class: "C5.1"
      description: "Extreme: marine, high chloride, aggressive chemicals"
      suitable_for: ["marine", "coastal", "offshore", "chemical plant", "chlorine exposure"]

  # Demanding environments that require upgraded materials
  demanding_environments:
    - name: "hospital"
      aliases: ["medical", "healthcare", "clinic", "surgery", "ICU", "szpital"]
      min_corrosion_class: "C5"
      required_materials: ["RF", "SF"]
      concern: "hygiene requirements, chemical disinfection, VDI 6022 compliance"

    - name: "food_processing"
      aliases: ["food", "pharma", "dairy", "beverage", "bakery", "meat", "spo≈ºywczy"]
      min_corrosion_class: "C5"
      required_materials: ["RF", "SF"]
      concern: "contamination risk, aggressive cleaning chemicals, FDA/HACCP compliance"

    - name: "pool"
      aliases: ["swimming", "aquatic", "spa", "wellness", "basen"]
      min_corrosion_class: "C5"
      required_materials: ["RF", "SF"]
      concern: "chlorine exposure, high humidity, accelerated corrosion"

    - name: "marine"
      aliases: ["coastal", "offshore", "ship", "port", "morski"]
      min_corrosion_class: "C5.1"
      required_materials: ["SF"]
      concern: "salt spray, extreme corrosion conditions"

    - name: "laboratory"
      aliases: ["lab", "research", "cleanroom", "laboratorium"]
      min_corrosion_class: "C5"
      required_materials: ["RF", "SF"]
      concern: "chemical exposure, contamination control"

    - name: "commercial_kitchen"
      aliases: ["kitchen", "restaurant", "catering", "fryer", "kuchnia", "sma≈ºalnia"]
      min_corrosion_class: "C4"
      required_materials: ["ZM", "RF"]
      concern: "grease, steam, cleaning chemicals"

# =============================================================================
# PRODUCT-APPLICATION RULES (Guardian Logic)
# =============================================================================
# These rules define which products are suitable for which applications.
# The LLM uses these to detect mismatches and suggest alternatives.

product_application_rules:
  # Product capabilities and limitations
  product_capabilities:
    - family: "GDB"
      full_name: "Bag Filter Housing"
      filters: ["dust", "particulate", "solid aerosols"]
      does_NOT_filter: ["gas", "odor", "fumes", "VOC", "smoke"]
      warning_applications:
        - trigger: ["exhaust fumes", "odor", "smell", "gas", "VOC", "spaliny", "smr√≥d", "zapach"]
          message: "GDB bag filters capture PARTICLES only, not gases or odors. For gas/odor removal, use GDC (carbon) series."
          alternative: "GDC"

    - family: "GDC"
      full_name: "Carbon Filter Housing"
      filters: ["gas", "odor", "VOC", "organic compounds"]
      does_NOT_filter: ["grease", "oil mist", "heavy particulate"]
      warning_applications:
        - trigger: ["grease", "oil", "fryer", "kitchen exhaust", "t≈Çuszcz", "olej", "sma≈ºalnia"]
          message: "Carbon filters (GDC) will clog rapidly with grease/oil. Requires grease pre-filtration (separators) upstream."
          alternative: "Grease separator + GDC"

    - family: "GDP"
      full_name: "Panel Filter Housing"
      type: "complete housing"
      warning_applications:
        - trigger: ["frame only", "no sheet", "bez blachy", "same ramki", "mounting frame"]
          message: "GDP is a complete housing. For mounting frames only, use PFF (Panel Filter Frame) series."
          alternative: "PFF"

    - family: "GDMI"
      full_name: "Insulated Filter Housing"
      special_feature: "thermal insulation"
      recommended_for: ["outdoor", "rooftop", "cold climate", "condensation risk"]

  # Installation environment warnings
  installation_warnings:
    - trigger: ["rooftop", "outdoor", "dach", "zewnƒôtrzny", "bez izolacji", "no insulation", "without insulation"]
      condition: "outdoor or rooftop"
      products_affected: ["GDB", "GDC", "GDP"]
      message: "‚ö†Ô∏è CRITICAL: Non-insulated housing on rooftop/outdoor WILL cause condensation. Water will form inside, damage filters, cause corrosion, and lead to system failure. Insulated housing (GDMI) is MANDATORY for outdoor installations."
      alternative: "GDMI"

# =============================================================================
# GEOMETRIC CONSTRAINTS (Guardian Logic)
# =============================================================================
# Physical dimension constraints that cannot be violated.

geometric_constraints:
  options_requiring_length:
    - option: "polisfiltr"
      aliases: ["polis", "polysfilter", "afterfilter", "szyna na polisfiltr", "rail"]
      min_length_mm: 900
      message: "Polysfilter rail option requires minimum housing length of 900mm."

    - option: "prefilter_frame"
      aliases: ["prefilter", "wstƒôpny", "ramka na filtr wstƒôpny"]
      additional_length_mm: 50
      message: "Pre-filter frame adds 50mm to total installation length."

  installation_tolerance:
    minimum_margin_mm: 10
    warning_message: "Zero tolerance fit (exact dimensions). Recommend 10mm+ margin for installation tolerances."

# =============================================================================
# ACCESSORY COMPATIBILITY (Guardian Logic)
# =============================================================================
# Which accessories work with which product families.

accessory_compatibility:
  - accessory: "EXL"
    full_name: "Eccentric Locking Mechanism"
    compatible_with: ["GDB", "GDMI", "GDP"]
    NOT_compatible_with: ["GDC"]
    reason: "GDC uses bayonet mounting system, not compatible with EXL eccentric locks."

  - accessory: "L"
    full_name: "Left Hinge Option"
    compatible_with: ["GDB", "GDC", "GDMI", "GDP"]

  - accessory: "F"
    full_name: "Flange Connection"
    compatible_with: ["GDB", "GDC", "GDMI", "GDP"]

# =============================================================================
# SAFETY DETECTION (Guardian Logic)
# =============================================================================
# Keywords that trigger safety-critical reviews.

safety_detection:
  hazard_domains:
    atex:
      keywords: ["ATEX", "explosion", "explosive", "Ex zone", "dust explosion", "wybuch"]
      materials: ["milk powder", "sugar", "flour", "grain", "wood dust", "coal", "aluminum"]
      severity: "critical"
      action: "block_with_safety_guard"

    chemical:
      keywords: ["chemical", "acid", "alkali", "solvent", "corrosive", "chemiczny", "kwas"]
      severity: "warning"
      action: "recommend_material_upgrade"

    hygiene:
      keywords: ["hospital", "medical", "pharma", "food", "cleanroom", "sterile", "szpital", "medyczny"]
      severity: "warning"
      action: "verify_material_compliance"

# =============================================================================
# CLARIFICATION RULES
# =============================================================================
# What parameters are required before making product recommendations.
# The LLM uses this as guidance for what questions to ask.

clarification_rules:
  # Decision tree for filter housing selection - ask in this order
  decision_flow:
    description: "Step-by-step parameter collection for filter housing recommendation"
    steps:
      - step: 1
        parameter: "filtration_purpose"
        question: "What do you need to filter?"
        why_needed: "Determines the correct product family (particles vs gases/odors)"
        options:
          - value: "particles"
            description: "Dust, particulates, solid aerosols"
            leads_to: ["GDB", "GDMI", "GDP"]
          - value: "gases_odors"
            description: "Gases, odors, VOC, fumes"
            leads_to: ["GDC", "GDC-FLEX", "GDMI-FLEX"]
          - value: "both"
            description: "Both particles and gases (multi-stage)"
            leads_to: ["GDB+GDC combination"]
        skip_if: "product family already specified (e.g., user said 'GDB housing')"

      - step: 2
        parameter: "installation_location"
        question: "Where will the housing be installed?"
        why_needed: "Determines insulation requirements and material grade"
        options:
          - value: "indoor"
            description: "Inside building, climate controlled"
            implications: ["no insulation required", "standard material OK"]
          - value: "outdoor"
            description: "Outside, exposed to weather"
            implications: ["insulation recommended (GDMI)", "higher corrosion class"]
          - value: "rooftop"
            description: "Rooftop installation"
            implications: ["insulation MANDATORY (GDMI)", "weather sealing needed"]
        skip_if: "GDMI already specified (implies insulation needed)"

      - step: 3
        parameter: "airflow"
        question: "What is the required airflow capacity (m¬≥/h)?"
        why_needed: "Determines housing size (Width √ó Height)"
        options:
          - value: "850"
            description: "Small room/office (~300√ó300)"
          - value: "3400"
            description: "Standard office unit (~600√ó600)"
          - value: "5000"
            description: "Large office/commercial (~900√ó600)"
          - value: "10000"
            description: "Industrial/large commercial"
          - value: "other"
            description: "Specify exact value"
        skip_if: "specific product code with size mentioned (e.g., GDB-600x600)"
        reference: "3400 m¬≥/h per 1/1 module (592√ó592mm) at 1.5 m/s"

      - step: 4
        parameter: "filter_type"
        question: "What type of filter will be used?"
        why_needed: "Determines housing length and locking mechanism"
        applies_to: ["GDB", "GDMI"]
        options:
          - value: "bag_filter_short"
            description: "Short bag filter (p√•sfilter) up to 450mm"
            housing_length: "550/600mm"
          - value: "bag_filter_long"
            description: "Long bag filter (p√•sfilter) up to 650mm"
            housing_length: "750/800mm"
          - value: "compact_filter"
            description: "Compact filter with 25mm frame"
            housing_length: "550/600mm or 750/800mm depending on depth"
          - value: "panel_filter"
            description: "Panel/flat filter (planfilter)"
            alternative_product: "GDP (250mm length)"

      - step: 5
        parameter: "filter_class"
        question: "What filter efficiency class is required?"
        why_needed: "Affects filter selection and may impact housing features"
        options:
          - value: "coarse"
            description: "COARSE (pre-filter, G4)"
          - value: "ePM10"
            description: "ePM10 (medium efficiency, M5-M6)"
          - value: "ePM1"
            description: "ePM1 (fine filter, F7-F9)"
          - value: "hepa"
            description: "HEPA (H13-H14, cleanroom)"
            note: "May require special housing features"
        skip_if: "general ventilation without specific requirements"

      - step: 6
        parameter: "housing_length"
        question: "Which housing length is needed?"
        why_needed: "Must accommodate filter depth + any accessories"
        applies_to: ["GDB", "GDMI"]
        options:
          - value: "550"
            description: "Short (550/600mm) - for filters up to 450mm"
          - value: "750"
            description: "Long (750/800mm) - for filters up to 650mm"
        skip_if: "filter_type already specified (can derive length)"
        default_suggestion: "For office and commercial applications, 750mm (long housing) is most commonly used as it accommodates standard bag filters."
        proactive_hint: "üí° 750mm is the most popular choice for general ventilation"

      - step: 7
        parameter: "connection_type"
        question: "What duct connection type is needed?"
        why_needed: "Affects how housing connects to ductwork"
        options:
          - value: "PG"
            description: "PG 20mm slip-in connection (standard)"
          - value: "F"
            description: "Flange 40mm connection"
        default: "PG"
        skip_if: "not explicitly required by customer"

      - step: 8
        parameter: "door_orientation"
        question: "Which side should the service door open?"
        why_needed: "Must match installation space constraints"
        options:
          - value: "R"
            description: "Right-hinged (standard)"
          - value: "L"
            description: "Left-hinged"
        default: "R"
        skip_if: "not explicitly required by customer"

  # Legacy format for backward compatibility
  required_parameters:
    - name: "filtration_purpose"
      aliases: ["filter type", "what to filter", "particles", "gases", "odors"]
      applies_to: ["all"]
      prompt: "What do you need to filter - particles (dust) or gases/odors?"
      priority: 1

    - name: "installation_location"
      aliases: ["location", "indoor", "outdoor", "rooftop", "installation"]
      applies_to: ["all"]
      prompt: "Where will the housing be installed (indoor/outdoor/rooftop)?"
      priority: 2

    - name: "airflow"
      aliases: ["capacity", "flow rate", "volume", "przep≈Çyw", "wydatek", "wydajno≈õƒá"]
      units: ["m¬≥/h", "cfm", "l/s"]
      applies_to: ["GDB", "GDC", "GDMI", "GDP", "GDF"]
      prompt: "What is the required airflow capacity?"
      priority: 3

    - name: "filter_type"
      aliases: ["bag filter", "compact filter", "p√•sfilter", "kompaktfilter"]
      applies_to: ["GDB", "GDMI"]
      prompt: "What type of filter will be used (bag filter short/long, compact filter)?"
      priority: 4

    - name: "dimensions"
      aliases: ["size", "duct size", "wymiary", "rozmiar"]
      units: ["mm", "inches"]
      applies_to: ["all"]
      prompt: "What are the duct connection dimensions (W√óH)?"
      priority: 5

  # When to skip clarification
  skip_clarification_when:
    - "specific product code mentioned (e.g., GDB-600x600)"
    - "competitor mapping exists in context"
    - "safety issue detected (handle safety first)"

  # Product family determination rules
  product_family_selection:
    particles_indoor: "GDB"
    particles_outdoor: "GDMI"
    particles_rooftop: "GDMI"
    gases_odors_indoor: "GDC"
    gases_odors_outdoor: "GDMI-FLEX"
    panel_filters: "GDP"

  # Housing length selection rules
  housing_length_rules:
    GDB:
      - condition: "short bag filter OR compact filter up to 450mm"
        length: "550/600mm"
      - condition: "long bag filter OR compact filter up to 650mm"
        length: "750/800mm"
    GDMI:
      - condition: "short bag filter OR compact filter up to 450mm"
        length: "600/650mm"
      - condition: "long bag filter OR compact filter up to 650mm"
        length: "850/900mm"
    GDC:
      - condition: "450mm carbon cylinders"
        length: "750/800mm"
      - condition: "450mm cylinders + polishing filter OR 600mm cylinders"
        length: "900/950mm"

  # Cross-selling categories (suggest after final recommendation)
  cross_selling_categories:
    description: "Accessory categories to suggest based on selected product"
    rules:
      - trigger: ["GDB", "GDMI"]
        suggest:
          - category: "Pre-filter"
            description: "G4 or M5 class - extends main filter life"
            reason: "Protects main filters by capturing coarse particles"
          - category: "Mounting frame (PFF)"
            description: "Required for filter installation"
            reason: "Provides secure filter mounting"
          - category: "Replacement filters"
            description: "Consumables for maintenance"
            reason: "Plan periodic filter changes"

      - trigger: ["ePM1", "F7", "F8", "F9"]
        suggest:
          - category: "Coarse pre-filter"
            description: "G4 class minimum"
            reason: "Fine filters require upstream protection"

      - trigger: ["HEPA", "H13", "H14"]
        suggest:
          - category: "Pre-filter"
            description: "G4 class"
            reason: "First stage protection"
          - category: "Fine filter"
            description: "F7-F9 class"
            reason: "Second stage protection before HEPA"

      - trigger: ["GDC", "carbon"]
        suggest:
          - category: "Pre-filter"
            description: "Minimum M5 class"
            reason: "Protects expensive carbon media from clogging"

  # Product code construction rules
  product_code_format:
    description: "How to construct full product codes"
    pattern: "{Family}-{Width}x{Height}-{Length}-{Door}-{Connection}-{Material}"
    components:
      family:
        description: "Product family"
        values: ["GDB", "GDMI", "GDC", "GDP"]
      size:
        description: "Housing width √ó height in mm"
        values: ["300x300", "600x600", "900x600"]
      length:
        description: "Housing depth in mm"
        values: ["550", "600", "750", "800", "850"]
      door:
        description: "Service door orientation"
        values:
          - code: "R"
            description: "Right-hinged (standard)"
          - code: "L"
            description: "Left-hinged"
        default: "R"
      connection:
        description: "Duct connection type"
        values:
          - code: "PG"
            description: "Slip-in 20mm (standard)"
          - code: "F"
            description: "Flange 40mm"
        default: "PG"
      material:
        description: "Material grade"
        values:
          - code: "FZ"
            description: "Galvanized steel (C3)"
            default_for: ["indoor", "office", "warehouse"]
          - code: "ZM"
            description: "Zinc-magnesium (C5)"
            default_for: ["outdoor", "coastal"]
          - code: "RF"
            description: "Stainless steel (C5)"
            default_for: ["hospital", "medical", "food", "cleanroom"]
        default: "FZ"

# =============================================================================
# SAMPLE QUESTIONS (for UI)
# =============================================================================

sample_questions:
  product_selection:
    label: "Product Selection"
    icon: "üì¶"
    questions:
      - "I need a GDB housing for hospital ventilation, 3400 m¬≥/h"
      - "Select carbon filter housing for 2000 m¬≥/h kitchen exhaust"
      - "What's the difference between GDB and GDMI?"

  guardian_tests:
    label: "Guardian Tests"
    icon: "üõ°Ô∏è"
    questions:
      - "I need GDB housing in galvanized steel (FZ) for a swimming pool ventilation system"
      - "We have exhaust fume smell in the parking garage. Select GDB bag filter to remove the odor"
      - "GDB housing for rooftop installation, no insulation needed (tight budget)"
      - "I need GDC carbon filters for a deep fryer hood exhaust"
      - "Can I use EXL locking mechanism with GDC carbon housing?"
      - "Hospital project - client wants cheap galvanized (FZ) housings to save budget"

  competitor_mapping:
    label: "Competitor Mapping"
    icon: "üîÑ"
    questions:
      - "What's the equivalent for AAF VariCel filter?"
      - "We need to replace Camfil Hi-Flo units"

# =============================================================================
# PROMPT TEMPLATES (Externalized)
# =============================================================================

prompt_templates:
  material_environment_warning: |
    ‚ö†Ô∏è Material Warning: {material} ({class}) is not suitable for {environment}. {concern}. Consider {recommended}.

  product_application_warning: |
    ‚ö†Ô∏è Application Warning: {message}. Consider {alternative}.

  geometric_constraint_warning: |
    ‚ö†Ô∏è Configuration Error: {message}

  zero_tolerance_warning: |
    ‚ö†Ô∏è Installation Warning: Exact fit ({calculated}mm = {available}mm) leaves no margin. Recommend {margin}mm clearance.

  accessory_incompatibility: |
    ‚ö†Ô∏è Compatibility Issue: {accessory} not compatible with {product}. {reason}

# =============================================================================
# ASSEMBLY CONFIGURATION (v2.7)
# =============================================================================
# Defines how multi-unit assemblies share properties.
# Python reads this list ‚Äî no property names hardcoded in code.

assembly:
  # Properties automatically synced across all units in the same assembly group.
  # Same duct = same dimensions/capacity. Remove a property to stop syncing it.
  # housing_length is intentionally NOT here ‚Äî each stage has its own from graph auto-resolve.
  shared_properties:
    - "filter_width"
    - "filter_height"
    - "housing_width"
    - "housing_height"
    - "airflow_m3h"

# =============================================================================
# SCOPE OF DELIVERY (v3.6)
# =============================================================================
# Defines what is included/excluded in standard housing delivery.
# Used by LLM prompt to correctly scope recommendations.

scope_of_delivery:
  included:
    - "Filter housing with service door (right-hinged standard, left-hinged option)"
    - "Pressure measurement nipples"
    - "JHL lock on service door"
    - "EXL eccentric locking mechanism (GDB, GDMI standard)"
    - "Filter rail with spring seal (GDP standard)"
    - "Bayonet mount plate for cartridges (GDC, GDC FLEX standard)"
  excluded:
    - "Transition pieces (PT flat, TT conical) for rectangular-to-round duct ‚Äî order separately"
    - "Filters, filter elements, and carbon cartridges"
    - "Mounting brackets and support structures"
    - "On-site insulation (for non-GDMI housings)"
  note: "Standard connection is PG 20mm slip-in. Flange 40mm available as option (surcharge, adds ~50mm to housing length)."

# =============================================================================
# DIMENSION & MATERIAL TABLES (Phase 2: Externalized from dimension_tables.py)
# =============================================================================

dimension_mapping:
  filter_to_housing:
    287: 300
    305: 300
    300: 300
    592: 600
    610: 600
    600: 600
    495: 500
    500: 500
    900: 900
    1200: 1200

corrosion_class_map:
  FZ: "C3"
  AZ: "C4"
  ZM: "C5"
  RF: "C5"
  SF: "C5.1"

housing_length_derivation:
  GDMI:
    - max_depth: 450
      length: 600
    - max_depth: 99999
      length: 850
  GDC:
    - max_depth: 450
      length: 750
    - max_depth: 99999
      length: 900
  GDB:
    - max_depth: 292
      length: 550
    - max_depth: 450
      length: 750
    - max_depth: 99999
      length: 900

orientation_threshold: 600

material_codes_extended:
  - code: "RF"
    aliases: ["STAINLESS", "STAINLESS STEEL", "ROSTFRI", "NIERDZEWNA"]
    extraction_keywords: ["stainless steel", "stainless", "nierdzewna", "rostfri", "edelstahl", "inox", "rf"]
  - code: "FZ"
    aliases: ["GALVANIZED", "ZINC", "CYNK"]
    extraction_keywords: ["galvanized", "verzinkt", "zinc", "cynk", "fz"]
  - code: "ZM"
    aliases: ["ZINKMAGNESIUM", "MAGNELIS"]
    extraction_keywords: ["zinkmagnesium", "magnelis", "zm"]
  - code: "SF"
    aliases: ["SENDZIMIR"]
    extraction_keywords: ["sendzimir", "sf"]
  - code: "AZ"
    aliases: []
    extraction_keywords: ["az"]

default_material: "FZ"

# =============================================================================
# SIZING RULES (reference airflow per product family & size)
# =============================================================================
sizing_rules:
  GDB:
    reference: "3400 m3/h per 1/1 module (592x592mm) at 1.5 m/s"
    sizes:
      "300x300": 850
      "600x600": 3400
      "900x600": 5000
  GDMI:
    reference: "3400 m3/h per 1/1 module at 1.5 m/s"
    sizes:
      "300x300": 850
      "600x600": 3400
      "900x600": 5000
  GDC:
    reference: "2000-3000 m3/h per 600x600 module"
    sizes:
      "600x600": 2500
      "900x600": 4000
  GDP:
    reference: "3000-4000 m3/h per 600x600"
    sizes:
      "600x600": 3500

# =============================================================================
# DEFAULT PRODUCT FAMILY
# =============================================================================
default_product_family: "GDB"

# =============================================================================
# FALLBACK KEYWORDS (for regex fallback paths in retriever + chat)
# =============================================================================
fallback_keywords:
  # Application keywords: used by detect_intent_fast() regex fallback
  application_keywords:
    hospital: ["hospital", "szpital", "medical", "clinic", "klinik"]
    kitchen: ["kitchen", "kuchnia", "restaurant", "restauracja", "food"]
    office: ["office", "biuro", "commercial", "komercyjny"]
    industrial: ["industrial", "przemys≈Çowy", "factory", "fabryka"]
    cleanroom: ["cleanroom", "czyste pomieszczenie", "pharma", "farmaceut"]

  # Environment terms: flat list for keyword-based rule search
  environment_terms:
    - "basen"
    - "pool"
    - "swimming"
    - "aquapark"
    - "szpital"
    - "hospital"
    - "kuchnia"
    - "kitchen"
    - "restaurant"
    - "restauracja"
    - "sma≈ºalnia"
    - "dach"
    - "roof"
    - "outdoor"
    - "zewnƒÖtrz"
    - "parking"
    - "gara≈º"
    - "cleanroom"
    - "czyste"
    - "sterylne"
    - "pharma"
    - "laboratorium"

  # Environment keyword to ENV_* ID mapping (regex fallback for installation_environment)
  environment_mapping:
    outdoor: "ENV_OUTDOOR"
    rooftop: "ENV_OUTDOOR"
    outside: "ENV_OUTDOOR"
    roof: "ENV_OUTDOOR"
    exterior: "ENV_OUTDOOR"
    indoor: "ENV_INDOOR"
    inside: "ENV_INDOOR"
    hospital: "ENV_HOSPITAL"
    clinic: "ENV_HOSPITAL"
    pool: "ENV_POOL"
    swimming: "ENV_POOL"
    kitchen: "ENV_KITCHEN"
    restaurant: "ENV_KITCHEN"
    kuchnia: "ENV_KITCHEN"
    fryer: "ENV_KITCHEN"
    atex: "ENV_ATEX"
    explosive: "ENV_ATEX"
    "ex zone": "ENV_ATEX"
    wybuch: "ENV_ATEX"
    marine: "ENV_MARINE"
    ship: "ENV_MARINE"
    cruise: "ENV_MARINE"
    offshore: "ENV_MARINE"
    vessel: "ENV_MARINE"
    naval: "ENV_MARINE"
    pharma: "ENV_PHARMACEUTICAL"
    cleanroom: "ENV_PHARMACEUTICAL"
    wastewater: "ENV_WASTEWATER"
    sewage: "ENV_WASTEWATER"

  # ENV_* to APP_* inference (for chlorine/application inference)
  env_to_app_inference:
    ENV_HOSPITAL: "APP_HOSPITAL"
    ENV_POOL: "APP_POOL"

  # Chat-mode application keyword mapping (keyword ‚Üí display name)
  chat_app_keywords:
    hospital: "Hospital"
    szpital: "Hospital"
    medical: "Hospital"
    kitchen: "Commercial Kitchen"
    restaurant: "Commercial Kitchen"
    outdoor: "Outdoor"
    roof: "Outdoor"
    rooftop: "Outdoor"
    pool: "Swimming Pool"
    basen: "Swimming Pool"

# =============================================================================
# SCRIBE HINTS (for LLM-based intent extraction in scribe.py)
# =============================================================================
scribe_hints:
  # Product inference: when user describes features but no product code
  product_inference:
    - keywords: ["insulated", "insulation", "thermal insulation", "condensation-proof"]
      product_family: "GDMI"
    - keywords: ["carbon", "activated carbon", "odor", "gas adsorption", "VOC"]
      product_family: "GDC"
      flex_variant: "GDC_FLEX"
    - keywords: ["cartridge", "carbon cartridge"]
      product_family: "GDC"
    - keywords: ["pre-filter", "protector", "mechanical pre-filtration"]
      product_family: "GDP"
    - keywords: ["pocket filter", "bag filter", "particle filter"]
      product_family: "GDB"

  # Connection type extraction
  connection_types:
    PG: ["PG", "slip-in", "PG profile"]
    F: ["flange", "fl√§ns", "flange connection"]

  # Material code hints for extraction
  material_hints:
    RF: ["stainless"]
    FZ: ["galvanized"]
    AZ: ["aluzink"]
    ZM: ["zinkmagnesium"]
    SF: ["sendzimir"]

  # Accessory detection hints
  accessory_hints:
    - code: "EXL"
      keywords: ["EXL", "eccentric lock", "quick release"]
    - code: "L"
      keywords: ["left hinge", "L hinge"]
    - code: "Round duct"
      keywords: ["round duct", "circular duct"]
    - code: "Transition"
      keywords: ["transition piece", "reducer", "adapter"]

# =============================================================================
# PARAMETER ROUTING (maps user-facing aliases to internal field names)
# =============================================================================
parameter_routing:
  airflow:
    field: "airflow_m3h"
    aliases: ["airflow", "airflow_m3h", "przep≈Çyw", "luftfl√∂de"]
  filter_depth:
    field: "filter_depth"
    aliases: ["filter_depth", "depth", "djup"]
  housing_length:
    field: "housing_length"
    aliases: ["housing_length", "length", "l√§ngd", "d≈Çugo≈õƒá"]
